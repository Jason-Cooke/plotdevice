<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html><head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>

  <title>PlotDevice Tutorials: Obstacle avoidance</title>
  <link charset="utf-8" href="../etc/manual.css" rel="stylesheet" type="text/css"/>

</head><body>
  <div class="link" id="nav">
    <h1><a href="../manual.html">Plotâ€ŠDevice <span>Tutorials</span></a></h1>

    <h3>Obstacle avoidance</h3>
  </div>

  <div class="article">
    <p><img alt="classes-creature3" height="200" src="../etc/tut/classes-creature3.jpg" width="550"/></p>
<pre>
<span class="c"># --- GEOMETRY --------------------------------------------------------------</span>
 
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> degrees, atan2
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> sqrt, <span class="nb">pow</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> radians, sin, cos
 
<span class="k">def</span> <span class="nf">angle</span>(x0, y0, x1, y1):
    <span class="sd">""" Returns the angle between two points.</span>
<span class="sd">    """</span>
    <span class="k">return</span> degrees( atan2(y1<span class="o">-</span>y0, x1<span class="o">-</span>x0) )    
 
<span class="k">def</span> <span class="nf">distance</span>(x0, y0, x1, y1):
    <span class="sd">""" Returns the distance between two points.</span>
<span class="sd">    """</span>        
    <span class="k">return</span> sqrt(<span class="nb">pow</span>(x1<span class="o">-</span>x0, <span class="mi">2</span>) <span class="o">+</span> <span class="nb">pow</span>(y1<span class="o">-</span>y0, <span class="mi">2</span>))
 
<span class="k">def</span> <span class="nf">coordinates</span>(x0, y0, distance, angle):
    <span class="sd">""" Returns the coordinates of given distance and angle from a point.</span>
<span class="sd">    """</span>
    <span class="k">return</span> (x0 <span class="o">+</span> cos(radians(angle)) <span class="o">*</span> distance, 
            y0 <span class="o">+</span> sin(radians(angle)) <span class="o">*</span> distance)
 
<span class="c"># --- WORLD -----------------------------------------------------------------</span>
 
<span class="k">class</span> <span class="nc">World</span>:
    <span class="k">def</span> <span class="nf">__init__</span>(<span class="bp">self</span>):
        <span class="bp">self</span><span class="o">.</span>obstacles <span class="o">=</span> []
 
<span class="c"># --- OBSTACLE --------------------------------------------------------------</span>
 
<span class="k">class</span> <span class="nc">Obstacle</span>:
    <span class="k">def</span> <span class="nf">__init__</span>(<span class="bp">self</span>, x, y, radius):
        <span class="bp">self</span><span class="o">.</span>x <span class="o">=</span> x
        <span class="bp">self</span><span class="o">.</span>y <span class="o">=</span> y
        <span class="bp">self</span><span class="o">.</span>radius <span class="o">=</span> radius
 
<span class="c"># --- CREATURE --------------------------------------------------------------</span>
 
<span class="k">class</span> <span class="nc">Creature</span>:    
 
    <span class="k">def</span> <span class="nf">__init__</span>(<span class="bp">self</span>, world, x, y, <span class="nf">speed</span><span class="o">=</span><span class="mf">1.0</span>, <span class="nf">size</span><span class="o">=</span><span class="mi">4</span>):        
 
        <span class="bp">self</span><span class="o">.</span>x <span class="o">=</span> x
        <span class="bp">self</span><span class="o">.</span>y <span class="o">=</span> y
        <span class="bp">self</span><span class="o">.</span><span class="nf">speed</span> <span class="o">=</span> <span class="nf">speed</span>
        <span class="bp">self</span><span class="o">.</span><span class="nf">size</span> <span class="o">=</span> <span class="nf">size</span>        
 
        <span class="bp">self</span><span class="o">.</span>world <span class="o">=</span> world
        <span class="bp">self</span><span class="o">.</span>feeler_length <span class="o">=</span> <span class="mi">25</span>        
 
        <span class="bp">self</span><span class="o">.</span>_vx <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span>_vy <span class="o">=</span> <span class="mi">0</span>    
 
    <span class="k">def</span> <span class="nf">heading</span>(<span class="bp">self</span>):        
 
        <span class="sd">""" Returns the creature's heading as angle in degrees.</span>
<span class="sd">        """</span> 
 
        <span class="k">return</span> angle(<span class="bp">self</span><span class="o">.</span>x, <span class="bp">self</span><span class="o">.</span>y, <span class="bp">self</span><span class="o">.</span>x<span class="o">+</span><span class="bp">self</span><span class="o">.</span>_vx, <span class="bp">self</span><span class="o">.</span>y<span class="o">+</span><span class="bp">self</span><span class="o">.</span>_vy)    
 
    <span class="k">def</span> <span class="nf">avoid_obstacles</span>(<span class="bp">self</span>, m<span class="o">=</span><span class="mf">0.4</span>, collision<span class="o">=</span><span class="mi">4</span>):
 
        <span class="c"># Find out where the creature is going.</span>
        a <span class="o">=</span> <span class="bp">self</span><span class="o">.</span>heading()        
 
        <span class="k">for</span> obstacle <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span>world<span class="o">.</span>obstacles:            
 
            <span class="c"># Calculate the distance between the creature and the obstacle.</span>
            d <span class="o">=</span> distance(<span class="bp">self</span><span class="o">.</span>x, <span class="bp">self</span><span class="o">.</span>y, obstacle<span class="o">.</span>x, obstacle<span class="o">.</span>y)            
 
            <span class="c"># Respond faster if the creature is very close to an obstacle.</span>
            <span class="k">if</span> d <span class="o">-</span> obstacle<span class="o">.</span>radius <span class="o">&lt;</span> <span class="mi">4</span>: m <span class="o">*=</span> <span class="mi">10</span>            
 
            <span class="c"># Check if the tip of the feeler falls inside the obstacle.</span>
            <span class="c"># This is never true if the feeler length </span>
            <span class="c"># is smaller than the distance to the obstable.</span>
            <span class="k">if</span> d <span class="o">-</span> obstacle<span class="o">.</span>radius <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span>feeler_length:
                tip_x, tip_y <span class="o">=</span> coordinates(<span class="bp">self</span><span class="o">.</span>x, <span class="bp">self</span><span class="o">.</span>y, d, a)    
                <span class="k">if</span> distance(obstacle<span class="o">.</span>x, obstacle<span class="o">.</span>y, 
                            tip_x, tip_y) <span class="o">&lt;</span> obstacle<span class="o">.</span>radius:                    
 
                    <span class="c"># Nudge the creature away from the obstacle.</span>
                    m <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="nf">speed</span>
 
                    <span class="k">if</span> tip_x <span class="o">&lt;</span> obstacle<span class="o">.</span>x: <span class="bp">self</span><span class="o">.</span>_vx <span class="o">-=</span> <span class="nf">random</span>(m)
                    <span class="k">if</span> tip_y <span class="o">&lt;</span> obstacle<span class="o">.</span>y: <span class="bp">self</span><span class="o">.</span>_vy <span class="o">-=</span> <span class="nf">random</span>(m)
                    <span class="k">if</span> tip_x <span class="o">&gt;</span> obstacle<span class="o">.</span>x: <span class="bp">self</span><span class="o">.</span>_vx <span class="o">+=</span> <span class="nf">random</span>(m)
                    <span class="k">if</span> tip_y <span class="o">&gt;</span> obstacle<span class="o">.</span>y: <span class="bp">self</span><span class="o">.</span>_vy <span class="o">+=</span> <span class="nf">random</span>(m) 
 
                    <span class="k">if</span> d <span class="o">-</span> obstacle<span class="o">.</span>radius <span class="o">&lt;</span> <span class="mi">4</span>: <span class="k">return</span>
 
    <span class="k">def</span> <span class="nf">roam</span>(<span class="bp">self</span>):
 
        <span class="sd">""" Creature changes heading aimlessly.</span>
<span class="sd">        With its feeler it will scan for obstacles and steer away.</span>
<span class="sd">        """</span>        
 
        <span class="bp">self</span><span class="o">.</span>avoid_obstacles()        
 
        v <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="nf">speed</span>
        <span class="bp">self</span><span class="o">.</span>_vx <span class="o">+=</span> <span class="nf">random</span>(<span class="o">-</span>v, v)
        <span class="bp">self</span><span class="o">.</span>_vy <span class="o">+=</span> <span class="nf">random</span>(<span class="o">-</span>v, v)
        <span class="bp">self</span><span class="o">.</span>_vx <span class="o">=</span> <span class="nb">max</span>(<span class="o">-</span>v, <span class="nb">min</span>(<span class="bp">self</span><span class="o">.</span>_vx, v))
        <span class="bp">self</span><span class="o">.</span>_vy <span class="o">=</span> <span class="nb">max</span>(<span class="o">-</span>v, <span class="nb">min</span>(<span class="bp">self</span><span class="o">.</span>_vy, v))         
 
        <span class="bp">self</span><span class="o">.</span>x <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span>_vx
        <span class="bp">self</span><span class="o">.</span>y <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span>_vy
 
<span class="c"># ---------------------------------------------------------------------------</span>
 
<span class="nf">size</span>(<span class="mi">550</span>, <span class="mi">200</span>)
 
<span class="c"># Create a world with obstacles at random positions.</span>
world <span class="o">=</span> World()
<span class="k">for</span> i <span class="ow">in</span> <span class="nb">range</span>(<span class="mi">15</span>):
    obstacle <span class="o">=</span> Obstacle(<span class="nf">random</span>(<span class="kc">WIDTH</span>), <span class="nf">random</span>(<span class="kc">HEIGHT</span>), <span class="nf">random</span>(<span class="mi">10</span>, <span class="mi">30</span>))
    world<span class="o">.</span>obstacles<span class="o">.</span>append(obstacle)
 
<span class="c"># Create a number of ants.</span>
ants <span class="o">=</span> []
<span class="k">for</span> i <span class="ow">in</span> <span class="nb">range</span>(<span class="mi">4</span>):
    ant <span class="o">=</span> Creature(world, <span class="mi">225</span>, <span class="mi">100</span>, <span class="nf">speed</span><span class="o">=</span><span class="mf">2.0</span>)
    ants<span class="o">.</span>append(ant)
 
<span class="nf">speed</span>(<span class="mi">30</span>)
<span class="k">def</span> <span class="nf">draw</span>():    
 
    <span class="nf">background</span>(<span class="mf">0.2</span>)    
 
    <span class="c"># Draw all the obstacles in the world.</span>
    <span class="nf">fill</span>(<span class="mf">0.5</span>, <span class="mf">0.5</span>)
    <span class="k">for</span> obstacle <span class="ow">in</span> world<span class="o">.</span>obstacles:
        <span class="nf">oval</span>(obstacle<span class="o">.</span>x <span class="o">-</span> obstacle<span class="o">.</span>radius,
             obstacle<span class="o">.</span>y <span class="o">-</span> obstacle<span class="o">.</span>radius,
             obstacle<span class="o">.</span>radius <span class="o">*</span> <span class="mi">2</span>,
             obstacle<span class="o">.</span>radius <span class="o">*</span> <span class="mi">2</span>)    
 
    <span class="c"># Draw each ant and its feeler.</span>
    <span class="nf">stroke</span>(<span class="mi">1</span>)
    <span class="nf">fill</span>(<span class="mi">1</span>, <span class="mf">0.5</span>)
    <span class="k">for</span> ant <span class="ow">in</span> ants:
        <span class="nf">push</span>()
        <span class="nf">transform</span>(<span class="kc">CORNER</span>)
        <span class="nf">translate</span>(ant<span class="o">.</span>x, ant<span class="o">.</span>y)
        <span class="nf">rotate</span>(<span class="o">-</span>ant<span class="o">.</span>heading())
        <span class="nf">line</span>(<span class="mi">0</span>, <span class="mi">0</span>, ant<span class="o">.</span>feeler_length, <span class="mi">0</span>)
        <span class="nf">pop</span>()
        <span class="nf">oval</span>(ant<span class="o">.</span>x<span class="o">-</span>ant<span class="o">.</span><span class="nf">size</span><span class="o">*</span><span class="mf">0.5</span>, ant<span class="o">.</span>y<span class="o">-</span>ant<span class="o">.</span><span class="nf">size</span><span class="o">*</span><span class="mf">0.5</span>, ant<span class="o">.</span><span class="nf">size</span>, ant<span class="o">.</span><span class="nf">size</span>)    
 
    <span class="c"># Move all the ants around.</span>
    <span class="k">for</span> ant <span class="ow">in</span> ants:
        ant<span class="o">.</span>roam()
</pre>
  </div>

</body></html>