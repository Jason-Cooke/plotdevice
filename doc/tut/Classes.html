<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>

  <title>PlotDevice Tutorials: Classes</title>
  <link charset="utf-8" href="../etc/manual.css" rel="stylesheet" type="text/css"/>

</head><body>
  <div class="link" id="nav">
    <h1><a href="../manual.html">Plot Device <span>Tutorials</span></a></h1>

    <h3>Classes</h3>

    <ul class="chapter">
      <li><a href="Animation.html">Animation →</a></li>
      <li>Chapter 11</li>
      <li><a href="Libraries.html">← Libraries</a></li>
    </ul>
  </div>

  <div class="article">
    <p>If you read about <a href="Variables.html">variables</a>, <a href="Repetition.html">repetition</a> and <a href="Commands.html">commands</a> you already know a
    great deal about how to keep your code tidy and organized. Variables can be used to store data,
    commands to manipulate data, and for-loops to do things (e.g. traverse <a href="Lists.html">lists</a>) multiple times. As you move on to bigger projects you’ll probably want
    to learn about classes as well. A class is a programming convention that defines a thing (or
    <b>object</b>) together with all of the thing’s <b>properties</b> (e.g. variables) and behavior
    <b>methods</b> (e.g. commands). If you take a look at the source code of PlotDevice libraries
    you’ll notice that they are full of classes.</p>
    <p>For example, a <i>Creature</i> class would consist of all the traits shared by different
    creatures, such as <i>size, position</i>, <i>speed</i> and <i>direction</i> (properties), and
    <i>avoid_obstacle()</i>, <i>eat_food()</i> (methods).</p>
    <p>We can then use the Creature class to define many different <b>instances</b> of a creature.
    For example, an ant is a small and speedy creature that wanders around randomly looking for
    food, avoiding obstacles by going around them. A dinosaur is also a creature, but bigger and
    slower. It eats anything crossing its path and avoids obstacles by crashing through them.</p>
    <ul>
      <li><b>class</b>: the abstract characteristics (properties and methods) of a thing.</li>
      <li><b>object</b>: one particular instance of a class.</li>
      <li><b>properties</b>: variables tied to an instance of a class.<br/></li>
      <li><b>methods</b>: commands that manipulate an instance’s properties.</li>
    </ul>

    <p> </p>
    <hr size="2" width="100%"/>

    <h2>Class definition and initialization</h2>

    <p>Each class has an <i>__init__()</i> method which is <b>executed once when an instance of the
    class is created</b>. The <i>__init__()</i> method sets all the starting values for an object’s
    properties.</p>
    <p>For example, here’s what a simple definition of a Creature class would look like:</p>
<pre>
<span class="k">class</span> <span class="nc">Creature</span>:
    
    <span class="k">def</span> <span class="nf">__init__</span>(<span class="bp">self</span>, x, y, <span class="nf">speed</span><span class="o">=</span><span class="mf">1.0</span>, <span class="nf">size</span><span class="o">=</span><span class="mi">4</span>):
        
        <span class="bp">self</span><span class="o">.</span>x <span class="o">=</span> x
        <span class="bp">self</span><span class="o">.</span>y <span class="o">=</span> y
        <span class="bp">self</span><span class="o">.</span><span class="nf">speed</span> <span class="o">=</span> <span class="nf">speed</span>
        <span class="bp">self</span><span class="o">.</span><span class="nf">size</span> <span class="o">=</span> <span class="nf">size</span>
</pre>

    <p>As you can see a creature has <i>x</i> and <i>y</i> properties (the location of the
    creature) and <i>speed</i> and <i>size</i> properties (which we’ll use to move the creature
    around). All of them can be set when a new creature is ‘instantiated’. The <i>speed</i> and
    <i>size</i> properties have default values so they are optional.</p>
<pre>ant <span class="o">=</span> Creature(<span class="mi">100</span>, <span class="mi">100</span>, <span class="nf">speed</span><span class="o">=</span><span class="mf">2.0</span>)
dinosaur <span class="o">=</span> Creature(<span class="mi">200</span>, <span class="mi">250</span>, <span class="nf">speed</span><span class="o">=</span><span class="mf">0.25</span>, <span class="nf">size</span><span class="o">=</span><span class="mi">45</span>)
</pre>

    <p>To change a property value for a creature later on we can simply do:</p>
<pre>ant<span class="o">.</span><span class="nf">speed</span> <span class="o">=</span> <span class="mf">2.5</span>
</pre>

    <p><u>Naming conventions:</u></p>
    <ul>
      <li>Class names use <span class="inline_code">CamelCase</span> notation.</li>
      <li>Properties that are only for private use inside the class start with _</li>
    </ul>

    <p> </p>
    <hr size="2" width="100%"/>

    <h2>Methods and the self parameter</h2>

    <p>Let’s add a <i>roam()</i> method to the Creature class to move creatures around randomly. A
    class method looks exactly like a command definition but it always takes <i>self</i> as the
    first parameter. The <i>self</i> parameter is the current instance of the class. It allows you
    to access all of an object’s current property values and methods from inside the method.</p>
<pre>
<span class="k">class</span> <span class="nc">Creature</span>: 
    
    <span class="k">def</span> <span class="nf">__init__</span>(<span class="bp">self</span>, x, y, <span class="nf">speed</span><span class="o">=</span><span class="mf">1.0</span>, <span class="nf">size</span><span class="o">=</span><span class="mi">4</span>):
        
        <span class="bp">self</span><span class="o">.</span>x <span class="o">=</span> x
        <span class="bp">self</span><span class="o">.</span>y <span class="o">=</span> y
        <span class="bp">self</span><span class="o">.</span><span class="nf">speed</span> <span class="o">=</span> <span class="nf">speed</span>
        <span class="bp">self</span><span class="o">.</span><span class="nf">size</span> <span class="o">=</span> <span class="nf">size</span>
        
        <span class="bp">self</span><span class="o">.</span>_vx <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span>_vy <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">roam</span>(<span class="bp">self</span>):
 
        <span class="sd">""" Creature changes heading aimlessly.</span>
<span class="sd">        """</span>
        
        v <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="nf">speed</span>
        <span class="bp">self</span><span class="o">.</span>_vx <span class="o">+=</span> <span class="nf">random</span>(<span class="o">-</span>v, v)
        <span class="bp">self</span><span class="o">.</span>_vy <span class="o">+=</span> <span class="nf">random</span>(<span class="o">-</span>v, v)
        <span class="bp">self</span><span class="o">.</span>_vx <span class="o">=</span> <span class="nb">max</span>(<span class="o">-</span>v, <span class="nb">min</span>(<span class="bp">self</span><span class="o">.</span>_vx, v))
        <span class="bp">self</span><span class="o">.</span>_vy <span class="o">=</span> <span class="nb">max</span>(<span class="o">-</span>v, <span class="nb">min</span>(<span class="bp">self</span><span class="o">.</span>_vy, v)) 
        
        <span class="bp">self</span><span class="o">.</span>x <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span>_vx
        <span class="bp">self</span><span class="o">.</span>y <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span>_vy
</pre>

    <p>So now we have added two new properties to the class, <i>_vx</i> and <i>_vy,</i> which store
    a creature’s current heading. Both property names start with an underscore because they are for
    private use inside the class methods (e.g. no one should directly manipulate <i>ant._dx</i>
    from the outside).</p>
    <p>Each time the <i>roam()</i> method is called we add or subtract something of the creature’s
    speed to the heading, like a compass twirling around randomly. We also make sure the horizontal
    and vertical heading do not exceed the creature’s speed. Otherwise the creature would start
    going faster and faster which isn’t very realistic. Finally, we update the creature’s position
    by moving it to the new heading.</p>
    <p>Now we can create two ants (a small fast one and a big slow one). Because their size and
    speed differ they will roam in different ways.</p>
<pre>ant1 <span class="o">=</span> Creature(<span class="mi">300</span>, <span class="mi">300</span>, <span class="nf">speed</span><span class="o">=</span><span class="mf">2.0</span>)
ant2 <span class="o">=</span> Creature(<span class="mi">300</span>, <span class="mi">300</span>, <span class="nf">speed</span><span class="o">=</span><span class="mf">0.5</span>, <span class="nf">size</span><span class="o">=</span><span class="mi">8</span>)
 
<span class="nf">speed</span>(<span class="mi">30</span>)
<span class="k">def</span> <span class="nf">draw</span>():
    ant1<span class="o">.</span>roam()
    ant2<span class="o">.</span>roam()
    <span class="nf">oval</span>(ant1<span class="o">.</span>x, ant1<span class="o">.</span>y, ant1<span class="o">.</span><span class="nf">size</span>, ant1<span class="o">.</span><span class="nf">size</span>)
    <span class="nf">oval</span>(ant2<span class="o">.</span>x, ant2<span class="o">.</span>y, ant2<span class="o">.</span><span class="nf">size</span>, ant2<span class="o">.</span><span class="nf">size</span>)
</pre>

    <p><img alt="classes-creature1" height="200" src="../etc/tut/classes-creature1.jpg" width="550"/></p>
    <p><a href="http://nodebox.net/code/data/media/classes-creature1.mov">Play movie</a></p>
    <p> </p>
    <hr size="2" width="100%"/>

    <h2>Taking it further: obstacle avoidance</h2>

    <p>Now that we know the basics about classes, properties and methods we can take things a lot
    further. We can define different classes for different things and have them interact with each
    other.</p>
    <p>If we want to have our little critters avoid obstacles while wandering around, they will
    need to have some sense of the world around them. Know where the obstacles are located. So
    we’ll need to keep track of obstacle instances. Then we’ll introduce the concept of a
    <b>feeler</b>. A feeler could be the creature’s sight, hearing or antennae. Basically it is a
    point in front of where the creature is heading. If this point falls inside an obstacle, it’s
    time for the creature to change its. direction.</p>
    <p><img alt="classes-creature2" height="200" src="../etc/tut/classes-creature2.jpg" width="550"/></p>
    <p><i>The creature is heading into an obstacle - it can touch the obstacle with its forward
    feeler.<br/>
    It needs to adjust its bearing clockwise to avoid the obstacle.<br/>
    <br/></i></p>
    <p><span class="orange_box">World class</span></p>
    <p>We’ll start out by creating a World class which we can use to store a list of obstacles.
    Later on we can add all sorts of other stuff to the world (e.g. weather methods, colony
    location properties, etc...).</p>
<pre>
<span class="k">class</span> <span class="nc">World</span>:    
    <span class="k">def</span> <span class="nf">__init__</span>(<span class="bp">self</span>):        
        <span class="bp">self</span><span class="o">.</span>obstacles <span class="o">=</span> []
</pre> 

    <p><span class="orange_box">Obstacle class</span></p>
    <p>Next we’ll make an Obstacle class.<br/>
    An obstacle in the world is a basic object that has a position and a radius.</p>
<pre>
<span class="k">class</span> <span class="nc">Obstacle</span>:    
    <span class="k">def</span> <span class="nf">__init__</span>(<span class="bp">self</span>, x, y, radius):        
        <span class="bp">self</span><span class="o">.</span>x <span class="o">=</span> x
        <span class="bp">self</span><span class="o">.</span>y <span class="o">=</span> y
        <span class="bp">self</span><span class="o">.</span>radius <span class="o">=</span> radius
</pre> 

    <p><span class="orange_box">Geometry</span></p>
    <p>To know if a creature is going to run into an obstacle we need to know <b>if the tip of its
    feeler intersects with an obstacle</b>. Obviously we’re going to need some math to calculate
    the coordinates of the tip of the feeler. Luckily everything we need is already described in
    the tutorial on <a href="Math.html">math geometry</a>. We can copy-paste the commands and add
    them to our script:</p>
<pre>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> degrees, atan2
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> sqrt, <span class="nb">pow</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> radians, sin, cos
 
<span class="k">def</span> <span class="nf">angle</span>(x0, y0, x1, y1):
    <span class="sd">""" Returns the angle between two points.</span>
<span class="sd">    """</span>
    <span class="k">return</span> degrees( atan2(y1<span class="o">-</span>y0, x1<span class="o">-</span>x0) )
 
<span class="k">def</span> <span class="nf">distance</span>(x0, y0, x1, y1):
    <span class="sd">""" Returns the distance between two points.</span>
<span class="sd">    """</span>        
    <span class="k">return</span> sqrt(<span class="nb">pow</span>(x1<span class="o">-</span>x0, <span class="mi">2</span>) <span class="o">+</span> <span class="nb">pow</span>(y1<span class="o">-</span>y0, <span class="mi">2</span>))
 
<span class="k">def</span> <span class="nf">coordinates</span>(x0, y0, distance, angle):
    <span class="sd">""" Returns the coordinates of given distance and angle from a point.</span>
<span class="sd">    """</span>
    <span class="k">return</span> (x0 <span class="o">+</span> cos(radians(angle)) <span class="o">*</span> distance, 
            y0 <span class="o">+</span> sin(radians(angle)) <span class="o">*</span> distance)
</pre> 

    <p>With the above <i>coordinates()</i> command we can:<br/></p>
    <ul>
      <li>calculate the location of a point (tip of the feeler)<br/></li>
      <li>at a given distance (feeler length)<br/></li>
      <li>under a given angle (creature heading)<br/></li>
      <li>from a starting point (creature location).</li>
    </ul><br/>

    <p><span class="orange_box">Obstacle avoidance</span></p>
    <p>So first of all we’ll need to add a new <i>feeler_length</i> property to the Creature class,
    and a new <i>heading()</i> method that calculates the angle between a creature’s current
    position and its next position. We also add a new <i>world</i> property to the Creature class.
    That way each creature has access to all the obstacles in the world. We loop through the list
    of the world’s obstacles in the <i>avoid_obstacles()</i> method.</p>
    <p>The <i>avoid_obstacles()</i> method will do the following:</p>
    <ul>
      <li>calculate the direction angle of a creature,</li>
      <li>traverse all obstacles in the world,</li>
      <li>for each obstacle, check if it is closer than the feeler length,</li>
      <li>if it is, check if the coordinates of the tip of the feeler are inside the obstacle,</li>
      <li>and if so, steer away in the most logical direction.</li>
    </ul>
<pre>
<span class="k">class</span> <span class="nc">Creature</span>:
    
    <span class="k">def</span> <span class="nf">__init__</span>(<span class="bp">self</span>, world, x, y, <span class="nf">speed</span><span class="o">=</span><span class="mf">1.0</span>, <span class="nf">size</span><span class="o">=</span><span class="mi">4</span>):
        
        <span class="bp">self</span><span class="o">.</span>x <span class="o">=</span> x
        <span class="bp">self</span><span class="o">.</span>y <span class="o">=</span> y
        <span class="bp">self</span><span class="o">.</span><span class="nf">speed</span> <span class="o">=</span> <span class="nf">speed</span>
        <span class="bp">self</span><span class="o">.</span><span class="nf">size</span> <span class="o">=</span> <span class="nf">size</span>
        
        <span class="bp">self</span><span class="o">.</span>world <span class="o">=</span> world
        <span class="bp">self</span><span class="o">.</span>feeler_length <span class="o">=</span> <span class="mi">25</span>
        
        <span class="bp">self</span><span class="o">.</span>_vx <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span>_vy <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">heading</span>(<span class="bp">self</span>):
        
        <span class="sd">""" Returns the creature's heading as angle in degrees.</span>
<span class="sd">        """</span>
        
        <span class="k">return</span> angle(<span class="bp">self</span><span class="o">.</span>x, <span class="bp">self</span><span class="o">.</span>y, <span class="bp">self</span><span class="o">.</span>x<span class="o">+</span><span class="bp">self</span><span class="o">.</span>_vx, <span class="bp">self</span><span class="o">.</span>y<span class="o">+</span><span class="bp">self</span><span class="o">.</span>_vy)
 
    <span class="k">def</span> <span class="nf">avoid_obstacles</span>(<span class="bp">self</span>, m<span class="o">=</span><span class="mf">0.4</span>, perimeter<span class="o">=</span><span class="mi">4</span>):
 
        <span class="c"># Find out where the creature is going.</span>
        a <span class="o">=</span> <span class="bp">self</span><span class="o">.</span>heading()
        
        <span class="k">for</span> obstacle <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span>world<span class="o">.</span>obstacles:
            
            <span class="c"># Calculate the distance between the creature and the obstacle.</span>
            d <span class="o">=</span> distance(<span class="bp">self</span><span class="o">.</span>x, <span class="bp">self</span><span class="o">.</span>y, obstacle<span class="o">.</span>x, obstacle<span class="o">.</span>y)
            
            <span class="c"># Respond faster if the creature is very close to an obstacle.</span>
            <span class="k">if</span> d <span class="o">-</span> obstacle<span class="o">.</span>radius <span class="o">&lt;</span> perimeter: m <span class="o">*=</span> <span class="mi">10</span>
            
            <span class="c"># Check if the tip of the feeler falls inside the obstacle.</span>
            <span class="c"># This is never true if the feeler length </span>
            <span class="c"># is smaller than the distance to the obstable.</span>
            <span class="k">if</span> d <span class="o">-</span> obstacle<span class="o">.</span>radius <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span>feeler_length:
                tip_x, tip_y <span class="o">=</span> coordinates(<span class="bp">self</span><span class="o">.</span>x, <span class="bp">self</span><span class="o">.</span>y, d, a)    
                <span class="k">if</span> distance(obstacle<span class="o">.</span>x, obstacle<span class="o">.</span>y, 
                            tip_x, tip_y) <span class="o">&lt;</span> obstacle<span class="o">.</span>radius:
                    
                    <span class="c"># Nudge the creature away from the obstacle.</span>
                    m <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="nf">speed</span>
                    <span class="k">if</span> tip_x <span class="o">&lt;</span> obstacle<span class="o">.</span>x: <span class="bp">self</span><span class="o">.</span>_vx <span class="o">-=</span> <span class="nf">random</span>(m)
                    <span class="k">if</span> tip_y <span class="o">&lt;</span> obstacle<span class="o">.</span>y: <span class="bp">self</span><span class="o">.</span>_vy <span class="o">-=</span> <span class="nf">random</span>(m)
                    <span class="k">if</span> tip_x <span class="o">&gt;</span> obstacle<span class="o">.</span>x: <span class="bp">self</span><span class="o">.</span>_vx <span class="o">+=</span> <span class="nf">random</span>(m)
                    <span class="k">if</span> tip_y <span class="o">&gt;</span> obstacle<span class="o">.</span>y: <span class="bp">self</span><span class="o">.</span>_vy <span class="o">+=</span> <span class="nf">random</span>(m)
 
                    <span class="k">if</span> d <span class="o">-</span> obstacle<span class="o">.</span>radius <span class="o">&lt;</span> perimeter: <span class="k">return</span>
 
    <span class="k">def</span> <span class="nf">roam</span>(<span class="bp">self</span>):
 
        <span class="sd">""" Creature changes heading aimlessly.</span>
<span class="sd">        With its feeler it will scan for obstacles and steer away.</span>
<span class="sd">        """</span>
        
        <span class="bp">self</span><span class="o">.</span>avoid_obstacles()
        
        v <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="nf">speed</span>
        <span class="bp">self</span><span class="o">.</span>_vx <span class="o">+=</span> <span class="nf">random</span>(<span class="o">-</span>v, v)
        <span class="bp">self</span><span class="o">.</span>_vy <span class="o">+=</span> <span class="nf">random</span>(<span class="o">-</span>v, v)
        <span class="bp">self</span><span class="o">.</span>_vx <span class="o">=</span> <span class="nb">max</span>(<span class="o">-</span>v, <span class="nb">min</span>(<span class="bp">self</span><span class="o">.</span>_vx, v))
        <span class="bp">self</span><span class="o">.</span>_vy <span class="o">=</span> <span class="nb">max</span>(<span class="o">-</span>v, <span class="nb">min</span>(<span class="bp">self</span><span class="o">.</span>_vy, v)) 
        
        <span class="bp">self</span><span class="o">.</span>x <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span>_vx
        <span class="bp">self</span><span class="o">.</span>y <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span>_vy
</pre>

    <p><img alt="classes-creature3" height="200" src="../etc/tut/classes-creature3.jpg" width="550"/><br/>
    <a href="http://nodebox.net/code/data/media/classes-creature3.mov">Play movie</a> | <a href="Obstacle_avoidance.html">view source code</a></p>
    <p>Another easy example of classes is the <a href="Tendrils.html">Tendrils</a> item in the
    gallery. </p>
  </div>

</body></html>